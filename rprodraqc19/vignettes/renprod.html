<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Déployez vos modèles R en production</title>
    <meta charset="utf-8" />
    <meta name="author" content="Bruno Tremblay" />
    <meta name="date" content="2019-05-06" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Déployez vos modèles R en production
### Bruno Tremblay
### 2019-05-06

---

class: withheader




## C'est qui le monsieur en avant?

Conseiller expert en actuariat équipe de recherche et modélisation [@LaCapitale](https://www.lacapitale.com/fr/emplois/actuariat)

Actuariat ULaval 2007, FCAS, CSPA

[bruno.tremblay@lacapitale.com](mailto:bruno.tremblay@lacapitale.com)  
[github@meztez](https://github.com/meztezgithub@meztez)  
[linkedin@neoxone](https://www.linkedin.com/in/neoxone/)

R Community highlight : 
&gt; La fois où Max Kuhn a accepté mon pull request. ![topedo](topedo.png)

&lt;img src="avatar.png" style="position:absolute; top:34%; right: 10%; width: 10%"&gt;

---
class: withheader

## Projet
Déployez une application pour utiliser un pipeline de modélisation prédictive

Ce qu'ils ont dit
&gt; R c'est pas faite pour rouler en production  
&gt; Python &gt; R

Ce que j'en pense
&gt; [Qualité du code + Composition de l'équipe] &gt; Choix de language&lt;sup&gt;1&lt;/sup&gt;

.footnote[[1] La plupart du temps]

---
class: withheader

## Architecture

&lt;div style="float: left; height:8em; width: 8em; background-color: #92C744; text-align: center"&gt;&lt;img src="package.png" style="width: 95%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ⇴&lt;/span&gt;
&lt;div style="float: left; height:4.5em; width: 8em; background-color: #92C744; text-align: center; padding-top: 3.5em"&gt;&lt;img src="opencpu.png" style="width: 95%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ◇ &lt;/span&gt;
&lt;div style="float: left; height:7em; width: 8em; background-color: orange; text-align: center; padding-top: 1em"&gt;&lt;img src="docker.png" style="width: 90%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ⇴ &lt;/span&gt;
&lt;div style="float: left; height:7.5em; width: 8em; background-color: orange; text-align: center; padding-top: 0.5em"&gt;&lt;img src="kubernetes.png" style="width: 85%"&gt;&lt;/div&gt;
&lt;div style="clear: both;"&gt;&lt;/div&gt;

## Outils

&lt;div style="float: left; height:7em; width: 8em; background-color: #92C744; text-align: center; padding-top: 1em"&gt;&lt;img src="r.png" style="width: 90%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ◆ &lt;/span&gt;
&lt;div style="float: left; height:5.5em; width: 8em; background-color: #92C744; text-align: center; padding-top: 2.5em"&gt;&lt;img src="rstudio.png" style="width: 95%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ◆ &lt;/span&gt;
&lt;div style="float: left; height:5.75em; width: 8em; background-color: #92C744; text-align: center; padding-top: 2.25em"&gt;&lt;img src="git.png" style="width: 90%"&gt;&lt;/div&gt;
&lt;span style="float: left; margin:0.35em 0em 0.35em 0em; font-size:4em; width: 2em; text-align: center"&gt; ◇ &lt;/span&gt;
&lt;div style="float: left; height:7.5em; width: 8em; background-color: orange; text-align: center; padding-top: 0.5em"&gt;&lt;img src="jenkins.png" style="width: 65%"&gt;&lt;/div&gt;
&lt;div style="clear: both;"&gt;&lt;/div&gt;

???

# Avantages 
- Package R
 - Standard
 - Portable
 - Documentation
- OpenCPU Server
 - API Dynamique
 - Balançage des charges
 - Multithreaded
- Docker
 - Persistance
 - Déploiement

---
class: withheader

## Structure du package&lt;sup&gt;1&lt;/sup&gt;

&lt;img src="template.png" style="float:right; width: 16%"&gt;

- `data` : Objets nécessaires au pipeline enregistré avec le package.
- `data-raw` : Entraînement des modèles et expérimentations.
- `man` : Documentation générée par roxygen2.
- `R/onLoad.R` : Exécuté au chargement du package.
- `R/predict.R` : Point d'entrée API.
- `R/prepare.R` : Ingénierie des fonctionnalités.
- `R/transform.R` : Adapter les données reçues par l'API.
- `R/utils.R` : Autres fonctions dont le warmup.
- `R/validate.R` : Validations pré traitement.
- `tests` : Tests unitaires.
- `vignettes` : Exemples d'appels ou d'utilisation.
- `.gitignore` : Fichiers ignorés git.
- `.Rbuildignore` : Fichiers ignorés R BUILD.
- `.RData` : ...
- `.RHistory` : ...
- `DESCRIPTION` : Description du package.
- `NAMESPACE` : Générée par roxygen2.
- `rprodraqc19.Rproj` : ...

.footnote[[1] https://support.rstudio.com/hc/en-us/articles/200486488-Developing-Packages-with-RStudio]

???

onLoad : pour augmenter les performances, les objets vont être déjà monté en mémoire
predict : fonction exportée
prepare vs transform :
-transform c'est pour mettre les données de l'API sous le même format que les données de l'entraînement
-prepare c'est pour mettre les données dans un format utilisable pour le modèle
validate : s'assurer qu'on a toute l'information nécessaire pour effectuer le traitement.

---
class: withheader
## Pratico-pratique


```r
library(profvis)
library(roxygen2)
library(opencpu)
debugonce()
ocpu_start_server()
```

#### Documenter avec `roxygen2`&lt;sup&gt;1&lt;/sup&gt;

#### Identifier les trous noirs avec `profvis`&lt;sup&gt;2&lt;/sup&gt;

#### Utiliser debug pour inspecter l'exécution

#### Valider l'API du package localement

&lt;img src="sonic.png" style="position:absolute; bottom:10%; right: 5%; width: 15%"&gt;

.footnote[[1] `vignette("roxygen2", package = "roxygen2")`  
[2] https://rstudio.github.io/profvis  
[3] https://cloud.opencpu.org/ocpu/test/]

???

Suivre la documentation RStudio pour la création de package

---
class: withheader
## Structure du repo

&lt;img src="template_repo.png" style="float: right; width: 24%"&gt;
- `apachemod` : Modules apache mod_dumpost ubuntu 18.04.
- `apachesites` : Configurations apache sites.
- `opencpu/Rprofile` : Code R démarrage.
- `opencpu/server.conf` : Configuration opencpu.
- `rprodraqc19` : Package.
- `.Dockerignore` : Fichiers ignorés Docker.
- `Dockerfile` : Configuration image Docker.
- `README.md` : Lecture libre.
- `rprodraqc19_0.1.0.tar.gz` : Source package built.
- `version.json` : Version récupérée par jenkins.

???

mod_dumpost pour logger les posts request, compilé manuellement
config apache très optional

---
class: withheader
## Cycle de vie des modèles

#### Versions de package
#### Environnements Dev / Test / Prod
#### Livraison continue
#### Intégration continue
#### Cohabitation des conteneurs

&lt;img src="continuous.gif" style="position:absolute; top:22%; right:22%; width:35%" /&gt;

???

Utiliser la version du package pour signaler de nouvelles versions
Isoler les environnements
Meilleure autonomie de déploiement
Effectuer des tests de régressions automatisés
Plusieurs version d'api peuvent cohabiter dans la grappe Kubernetes

---
class: withheader

## MacGyver (devops)

####Appels API
####Contrat d'appel
####Tests de charges
####Logging

&lt;img src="fine.png" style="position:absolute; top:32%; right:10%; width: 40%" /&gt;
&lt;img src="devops.jpg" style="position:absolute; top:54%; right:60%; width: 30%" /&gt;

???

Changer la version majeur de l'api lorsque le contrat change
Définir le contrat d'appel, latence, réponses
Effectuer des tests de charge pour trouver l'équilibre pour les performances
Mettre en place des journalisations adéquate
Trouver et prévoir les problèmes

---
class: withheader

# Références devops
https://www.opencpu.org/api.html  
https://www.opencpu.org/download.html  
https://github.com/cw25/opencpu_service_ci_tutorial  
https://www.json.org/  
https://httpd.apache.org/docs/2.4/configuring.html  
https://cloud.google.com/kubernetes-engine/docs/  
https://cloud.google.com/blog/products/ai-machine-learning/making-the-machine-the-machine-learning-lifecycle  


---
class: allcode
experiments.R


```r
library(odbc)
library(data.table)
library(xgboost)
library(Matrix)
library(rprodraqc19)
library(usethis)

con &lt;- dbConnect(odbc(), "DSN", encoding = "latin1", bigint = "integer")
src &lt;- dbGetQuery(con, "SELECT ... FROM ... WHERE ...")

setDT(src)
*validate(src)
*model_data &lt;- prepare(copy(src))

n &lt;- nrow(model_data)  
set.seed(90210)  
train_indices &lt;- sort(sample(1:n,0.8*n))  
valid_indices  &lt;- (1:n)[-train_indices]  

mtrx_train &lt;- xgb.DMatrix(model_data[train_indices, ], label = ifelse(src[train_indices]$TARGET == "O", 1, 0))
mtrx_valid &lt;- xgb.DMatrix(model_data[valid_indices, ], label = ifelse(src[valid_indices]$TARGET == "O", 1, 0))

set.seed(1234)  
xgb.tree &lt;- xgb.train(data = mtrx_train,
                      watchlist = list(eval = mtrx_valid, train = mtrx_train),
                      nrounds = 500,
                      objective = "binary:logistic",
                      booster = "gbtree",
                      print_every_n = 50,
                      max_depth = 8,
                      subsample = 0.7,
                      colsample_bytree = 1,
                      eta = 0.03)

xgb.tree$evaluation_log[which.min(xgb.tree$evaluation_log$eval_error)]

trained_model &lt;- xgb.tree
data_template &lt;- rprodraqc2019:::data_template
reference_object &lt;- rprodraqc2019:::reference_object

*use_data(trained_model, data_template, reference_object, internal = FALSE, overwrite = TRUE)
```
---
class: allcode
onLoad.R


```r
.onLoad &lt;- function(lib, pkg){
  utils::data(trained_model,
              data_template,
              reference_object,
              package = pkg, envir = parent.env(environment()))
}
```
utils.R


```r
year_diff &lt;- function(time1, time2) {
* time1 &lt;- as.POSIXlt(time1, "GMT")
  time2 &lt;- as.POSIXlt(time2, "GMT")
  yeardiff &lt;- time2$year - time1$year
  yeardiff &lt;- ifelse(time2$mon &lt; time1$mon | (time2$mon == time1$mon &amp; time2$mday &lt; time1$mday),
                     yeardiff - 1,
                     yeardiff)
  
  return(as.numeric(yeardiff))
}

...

#' @importFrom ...
#' @export
*warmup &lt;- function() {

  input &lt;- jsonlite::fromJSON('[{"..."}]')
  setDT(input)
  replicate(3, prepare(copy(input)))

  return(invisible())
}
```
---
class: allcode
transform.R


```r
#' @importFrom ...
transform &lt;- function(input) {

  setDT(input)
  
  old = c("VAR1", ...)
  new = c("MODVAR1", ...)
  setnames(input, old, new, skip_absent = TRUE)

  input[, VAR4 := "*"]
  input[, VAR5 := as.numeric(VAR5)]
* input[, DATE := as.POSIXct(DATE, tz = "UTC")]

  invisible(input)
}
```
validate.R


```r
#' @export
validate &lt;- function(input) {
  selected &lt;-  c("MODVAR1", "DATE",  ...)
  stopifnot(all(selected %in% names(input)))
  removed &lt;- names(input)[!names(input) %in% selected]
  input[, removed := NULL]
  invisible(x)
}
```

???

transform parce que l'input opencpu est un data.frame

on veut une préparation unique pour l'api et l'utilisation interne du package

---
class: allcode
prepare.R


```r
#' @importFrom ...
#' @export
prepare &lt;- function(input) {

  if (nrow(input) &gt; 1) {
    if (all(is.na(input$MODVAR1))) {input[, MODVAR1 := as.character(MODVAR1)]}
  }

  input[, ':=' (JOURSEMAINE = wday(DATE), MOIS = month(DATE), ANNEE = year(DATE))]

  input[is.na(VAR4), VAR4 := "NR"]

  input[, AGE := 0]
  input[!is.na(DATE_ACHAT), AGE_ACHAT := year_diff(DATE_ACHAT, DATE)]
  input[AGE_ACHAT &lt; -1, AGE_ACHAT := -1]
  input[AGE_ACHAT &gt; 50, AGE_ACHAT := 50]

  input[, ':=' (DATE = NULL, DATE_ACHAT = NULL)]

* input[reference_object, on = "MODVAR1 == CP13", TERRITOIRE := TERRCP13]

  for (var in names(input)) {
    if (is.factor(reference_object[[var]])) {
      lvl &lt;- levels(reference_object[[var]])
*     fact &lt;- factor(input[[var]], lvl)
      if (sum(is.na(fact))) {
        val &lt;- sort(unique(input[[var]][is.na(fact)]))
        remp &lt;- lvl[1]
        warning(paste("Valeur(s) (", paste0(val,collapse = ","),") du champ", var ,
                      "non comprise dans le domaine reconnu (",
                      paste(lvl, collapse = ", "),"). Le programme utilisera",
                      remp, "comme substitution."))
        fact[is.na(fact)] &lt;- remp
      }
      input[[var]] &lt;- fact
    }
  }

  smm &lt;- fspmatrix(input[, names(reference_object), with = FALSE])

  return(smm)
}
```
---
class: allcode
predict.R


```r
#' @export
predict_model_api &lt;- function(input) {
  transform(input)
  predict_model(input)
}

#' @importFrom ...
#' @export
predict_model &lt;- function(input) {
  
  validate(input)
  model_data &lt;- prepare(copy(src))
  model_revision &lt;- list("model revision" = as.character(packageVersion("rprodraqc19")))
  model_predictions &lt;- predict(object = trained_model, newdata = xgb.DMatrix(model_data))
  
  return(list("model revision" = model_revision, "model predictions" = model_predictions))
}
```
---
class: allcode
DESCRIPTION


```r
Package: rprodraqc19
Type: Package
Title: Pseudo code template
Version: 0.1.0
Author: Bruno Tremblay
Maintainer: Bruno Tremblay &lt;bruno.tremblay@lacapitale.com&gt;
Description: It is a placeholder
License: GPL-2
Encoding: UTF-8
LazyData: false
Depends: R (&gt;= 2.10), xgboost, Matrix, data.table
Imports:
  jsonlite
```
.gitignore


```r
.Rproj.user
.Rhistory
.RData
.Ruserdata
```
.Rbuildignore


```r
^.*\.Rproj$
^\.Rproj\.user$
^\.RData$
^\.Rhistory$
^data-raw$
^vignettes$
^tests$
```
---
class: allcode
Rprofile


```r
library(rprodraqc19)
*warmup()
```

server.conf


```r
{
    "enable.api.library": true,
    "enable.api.apps": false,
    "enable.api.user": false,
    "enable.api.tmp": false,
    "enable.cors" : true,
    "enable.post.code": false,
    "enable.rlimits" : true,
    "error.showcall": true,
    "smtp.server" : "localhost",
    "httpcache.post": 300,
    "httpcache.lib": 86400,
    "httpcache.apps": 900,
    "httpcache.tmp": 86400,
    "httpcache.static": 31536000,
    "key.length" : 13,
    "repos": "https://cran.rstudio.com",
    "rlimit.as": 4e9,
    "rlimit.fsize": 1e9,
    "rlimit.nproc": null,
    "timelimit.get": 60,
    "timelimit.post": 90,
    "timelimit.webhook": 900,
    "preload": ["lattice","rprodraqc19"]
}
```

???

warmup pour certaines fonctions, meilleurs performances

---
.Dockerignore


```r
rprodraqc19
```

Dockerfile


```r
FROM opencpu/base:latest
  
WORKDIR /src
COPY ./rprodraqc19_0.1.0.tar.gz /rprodraqc19_0.1.0.tar.gz
COPY ./opencpu/Rprofile /etc/opencpu/Rprofile
COPY ./opencpu/server.conf /etc/opencpu/server.conf

RUN apt-get update
*RUN apt-get install ...
RUN R CMD INSTALL /rprodraqc19_0.1.0.tar.gz
```

Useful docker command


```r
docker run -d -p 8004:8004 image
docker exec -i -t image /bin/bash
docker image ls -a
docker ps
docker cp image:src dest
docker kill image
docker image rm
docker container ls -a
```

???

apt-get install pour installer les librairies unix requise par les packages R
commande unix ldd, pratique pour voir qu'est-ce qui manque
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
